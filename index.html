<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>EARLY ACCESS FARPG</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="TemplateData/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="TemplateData/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="TemplateData/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000000;
        }
        #unity-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        #unity-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            overflow: hidden;
        }
        /* Hide scrollbars */
        ::-webkit-scrollbar { display: none; }
        html { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="unity-container">
        <iframe id="unity-iframe"></iframe>
    </div>

    <script>
        // --- 1. Variables & References ---
        const container = document.getElementById('unity-container');
        const iframe = document.getElementById('unity-iframe');
        let deferredPrompt;
        let isFullscreen = false;

        // --- 2. Game Launcher (Prevent Double Audio Fix) ---
        function launchGame() {
            console.log("Launching Game...");
            // Only set the source now, ensuring single load
            if (!iframe.src || iframe.src === 'about:blank' || iframe.src === '') {
                iframe.src = "game.html";
            }
        }

        // --- 3. Version Control & Cache Purge ---
        async function checkGameVersion() {
            try {
                // Fetch version with timestamp to bypass JSON caching
                const response = await fetch('version.json?t=' + Date.now());
                if (!response.ok) throw new Error("Offline or Missing Version File");

                const data = await response.json();
                const serverVersion = data.version;
                const localVersion = localStorage.getItem('farpg_version');

                console.log(`Version Check - Local: ${localVersion} | Server: ${serverVersion}`);

                // If versions mismatch, Nuke everything
                if (localVersion && localVersion !== serverVersion) {
                    console.warn("Update detected! Purging cache...");
                    
                    // A. Update stored version
                    localStorage.setItem('farpg_version', serverVersion);

                    // B. Delete all Caches
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(key => caches.delete(key)));
                    }

                    // C. Unregister Service Workers
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // D. Force Hard Reload (Get new files)
                    window.location.reload(true);
                    return; 
                } 
                
                // If first time load, save version
                if (!localVersion) {
                    localStorage.setItem('farpg_version', serverVersion);
                }

                // Launch Game
                launchGame();

            } catch (error) {
                console.log("Offline mode or Error. Launching cached game.");
                // Fallback: Launch game from cache if offline
                launchGame();
            }
        }

        // --- 4. Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((reg) => console.log('SW Registered'))
                .catch((err) => console.log('SW Error:', err));
        }

        // --- 5. Fullscreen Logic ---
        function toggleFullscreen() {
            if (!isFullscreen) {
                if (container.requestFullscreen) container.requestFullscreen();
                else if (container.mozRequestFullScreen) container.mozRequestFullScreen();
                else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
                else if (container.msRequestFullscreen) container.msRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        }

        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || 
                              document.webkitFullscreenElement || document.msFullscreenElement);
            
            // Notify game.html (Unity) about the change
            if (iframe.contentWindow) {
                const msg = isFullscreen ? 'enterFullscreen' : 'exitFullscreen';
                iframe.contentWindow.postMessage(msg, '*');
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // --- 6. Event Listeners (PWA & Iframe Communication) ---
        
        // Capture PWA install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log("PWA Install Prompt Captured");
        });

        // Listen for messages from game.html
        window.addEventListener('message', function(event) {
            // Security check: ensure message is from our iframe
            if (event.source === iframe.contentWindow) {
                
                // Toggle Fullscreen Request
                if (event.data === 'toggleFullscreen') {
                    toggleFullscreen();
                }
                
                // PWA Install Request (from pressing 'I')
                if (event.data === 'installPWA') {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted install');
                            }
                            deferredPrompt = null;
                        });
                    } else {
                        console.log("PWA not installable or already installed");
                    }
                }
            }
        });

        // --- 7. Start the sequence ---
        checkGameVersion();

    </script>
</body>
</html>